# 成就触发系统实现指南 (CB-DESIGN for CB-FEATURES)

## 1. 概述

本文档为CB-FEATURES团队提供CultureBridge平台成就触发系统的具体实现指南，是对《NFT成就触发系统技术规范》的补充。本文档重点关注系统架构实现、与智能合约的交互、与前端的API设计、数据存储、性能优化和错误处理，确保系统实现符合设计规范并能与其他模块无缝集成。

## 2. 系统架构实现

### 2.1 核心组件实现

- **用户行为监听器 (Event Listeners)**:
    - **实现方式**: 可以是多个独立的微服务或模块，分别监听不同来源的事件（如平台API、区块链事件、社交平台Webhook）。
    - **区块链监听**: 使用ethers.js或web3.js库，通过WebSocket或轮询方式监听`CBNFTCore`, `CBGovernorCore`等合约的关键事件。
        - **关键事件**: `AchievementMinted`, `VoteCast`, `ProposalCreated`, `TokenStaked`, `ContentPublished`, `CourseCompleted` (如果链上记录)。
        - **事件处理**: 确保事件处理具有幂等性，防止重复处理（使用交易哈希+日志索引作为唯一标识）。处理失败时应有重试机制和错误记录。
        - **区块确认**: 等待足够的区块确认数（例如6-12个）再处理事件，以应对区块链重组。
    - **平台API监听**: 监听内部平台（如学习平台、内容平台）通过消息队列（如RabbitMQ, Kafka）或Webhook发送的行为事件。
    - **数据标准化**: 将不同来源的事件数据标准化为统一的内部事件格式。

- **成就条件评估器 (Condition Evaluator)**:
    - **实现方式**: 一个核心服务，接收标准化的事件数据，并根据成就定义进行评估。
    - **规则引擎**: 可以考虑使用简单的规则引擎或自定义逻辑来评估复杂条件（累计、组合、时间）。
    - **状态查询**: 需要高效查询用户进度存储（数据库）以评估累计和时间条件。
    - **并发处理**: 应能并发处理来自不同用户的事件评估请求。

- **成就解锁执行器 (Unlock Executor)**:
    - **实现方式**: 一个独立的服务或模块，负责在条件满足时执行解锁操作。
    - **合约交互**: 调用`CBAchievementManager`或`CBNFTCore`的`unlockAchievement`或`mintAchievement`函数。
        - **安全**: 确保调用合约的账户拥有必要的权限（`MINTER_ROLE`或类似角色）。私钥管理必须安全。
        - **Gas管理**: 监控并管理交易的Gas费用。实现Gas价格动态调整策略。
        - **交易监控**: 监控链上交易状态，处理交易失败（如Gas不足、合约拒绝）的情况，实现重试逻辑。
    - **数据库更新**: 更新用户进度存储，标记成就已解锁。
    - **通知**: 调用通知服务，通知用户成就解锁。

### 2.2 技术栈建议

- **语言**: Node.js (TypeScript), Python, Go
- **数据库**: PostgreSQL (用于结构化进度数据), Redis (用于缓存和计数器)
- **消息队列**: RabbitMQ, Kafka (用于内部事件传递)
- **Web3库**: ethers.js, web3.py
- **框架**: NestJS, Django, Flask, Gin

## 3. 与智能合约的交互 (CB-BACKEND)

### 3.1 事件监听

- **配置**: 系统应可配置监听的合约地址、ABI和起始区块。
- **过滤**: 有效利用合约事件的`indexed`参数进行服务器端过滤，减少不必要的事件处理。
- **错误处理**: 稳健处理RPC节点连接错误、超时和区块链重组。
- **状态同步**: 定期与链上状态进行核对，确保监听器没有遗漏事件。

### 3.2 合约调用

- **接口封装**: 将与合约的交互封装成独立的模块或服务，便于管理和测试。
- **Nonce管理**: 正确管理调用账户的Nonce，避免交易失败或顺序错乱。
- **Gas估算与设置**: 实现动态Gas价格估算，并允许设置Gas上限。
- **返回值处理**: 正确处理合约调用的返回值和可能抛出的错误。
- **权限管理**: 确保调用合约的账户拥有正确的角色和权限。

## 4. 与前端的API设计 (CB-FRONTEND)

### 4.1 核心API端点

- **`GET /users/{userId}/achievements`**: 获取用户已解锁的成就列表。
    - **参数**: `userId` (用户平台ID或钱包地址), `page`, `limit`, `sortBy`, `filterByType`
    - **响应**: 成就列表（包含`achievementId`, `name`, `description`, `imageUrl`, `rarity`, `unlockTimestamp`, `tokenId`等）和分页信息。
- **`GET /users/{userId}/progress`**: 获取用户所有成就的当前进度。
    - **参数**: `userId`
    - **响应**: 一个对象，键为成就条件ID (`criteriaId`)，值为当前进度 (`currentValue`, `targetValue`)。
- **`GET /achievements/{achievementId}`**: 获取特定成就的详细定义。
    - **参数**: `achievementId`
    - **响应**: 成就详情（名称、描述、类型、稀有度、解锁条件、关联权益等）。
- **`POST /events` (内部或受保护)**: 接收来自平台其他部分的标准用户行为事件。
    - **请求体**: 标准化的事件数据结构。
    - **响应**: 确认接收或处理状态。

### 4.2 API设计原则

- **RESTful**: 遵循RESTful设计原则。
- **认证与授权**: 使用JWT或其他机制保护API端点。
- **数据格式**: 使用JSON。
- **错误处理**: 返回标准化的错误响应码和信息。
- **文档**: 提供清晰的API文档（如Swagger/OpenAPI）。
- **性能**: 对常用查询进行缓存。

## 5. 数据存储

### 5.1 用户进度存储

- **数据库选择**: 关系型数据库（如PostgreSQL）适合存储结构化的进度数据。
- **数据模型**: 设计清晰的数据模型来存储用户、成就定义、成就条件和用户进度。
    - `Users` (userId, walletAddress, ...)
    - `Achievements` (achievementId, name, description, type, rarity, ...)
    - `AchievementCriteria` (criteriaId, achievementId, type, threshold, operator, timeframe, ...)
    - `UserProgress` (userId, criteriaId, currentValue, lastUpdated, ...)
    - `UserAchievements` (userId, achievementId, tokenId, unlockTimestamp, ...)
- **索引**: 为常用查询字段（如`userId`, `criteriaId`, `achievementId`）创建索引。
- **计数器优化**: 对于高频更新的累计条件，可以考虑使用Redis等内存数据库进行计数，定期同步回主数据库。

### 5.2 缓存

- **缓存策略**: 对不经常变化的成就定义和用户已解锁成就列表进行缓存（如使用Redis）。
- **缓存失效**: 设计合理的缓存失效策略（基于时间或事件驱动）。

## 6. 性能优化

- **异步处理**: 将耗时的操作（如合约调用、复杂评估）放入后台任务队列处理。
- **数据库优化**: 优化数据库查询，使用连接池。
- **批量处理**: 对事件处理和合约调用尽可能进行批量操作。
- **水平扩展**: 设计系统架构时考虑无状态服务，便于水平扩展。
- **监控**: 实施全面的性能监控，识别瓶颈。

## 7. 错误处理与日志

- **统一错误码**: 定义统一的内部错误码，便于问题定位。
- **详细日志**: 记录关键操作、错误信息和系统状态。
    - **日志级别**: 使用不同的日志级别（DEBUG, INFO, WARN, ERROR）。
    - **结构化日志**: 使用JSON或其他结构化格式，便于日志分析系统处理。
- **告警**: 对关键错误（如合约调用失败、数据库连接失败、事件处理积压）设置告警。
- **重试机制**: 对可恢复的错误（如网络抖动、RPC节点临时故障）实现带有指数退避的重试机制。

## 8. 结论

成就触发系统是连接用户行为、平台功能和区块链NFT的关键枢纽。CB-FEATURES团队在实现过程中，应严格遵循本指南和相关技术规范，注重系统的可靠性、可扩展性和安全性。与CB-BACKEND和CB-FRONTEND团队保持密切沟通，确保接口一致性和集成顺畅，是成功交付高质量成就触发系统的关键。

请在开发过程中持续进行测试（单元测试、集成测试），并关注性能监控和日志分析，及时发现并解决问题。
