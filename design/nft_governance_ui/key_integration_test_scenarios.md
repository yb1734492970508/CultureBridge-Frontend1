# NFT与治理系统关键集成测试场景 (CB-DESIGN for CB-FEATURES - Day 15)

## 1. 概述

本文档基于《NFT与治理系统集成测试指南》，为CB-FEATURES团队提炼了关键的集成测试场景和预期结果。旨在帮助团队聚焦核心功能，高效验证成就触发系统和治理流程系统与智能合约的集成效果。

## 2. 关键测试场景

### 2.1 成就触发系统

| 场景ID | 场景描述 | 关键验证点 | 预期结果 |
|---|---|---|---|
| **ITS-ACH-01** | **基本成就解锁** | 用户完成简单条件（如首次登录），系统触发合约解锁成就 | 1. `AchievementUnlocked`事件被捕获 2. 用户获得对应NFT 3. 数据库状态更新 4. 前端显示解锁 |
| **ITS-ACH-02** | **累计成就解锁** | 用户累计完成N次操作（如发布5篇内容），系统触发合约解锁成就 | 1. 累计计数准确 2. 达到阈值时触发解锁 3. 用户获得对应NFT |
| **ITS-ACH-03** | **链上条件成就解锁** | 用户完成链上操作（如首次投票），系统监听事件并触发合约解锁成就 | 1. 链上事件被正确监听 2. 条件评估准确 3. 用户获得对应NFT |
| **ITS-ACH-04** | **权益自动应用** | 成就解锁后，关联的权益（如投票权重加成）自动生效 | 1. `RewardExecuted`或类似事件被触发 2. 用户权益状态更新 3. 调用相关查询接口验证权益生效 |
| **ITS-ACH-05** | **解锁失败处理** | 模拟合约调用失败（如Gas不足），系统正确处理错误 | 1. 捕获合约错误 2. 记录错误日志 3. 向用户提供友好提示 4. 系统状态保持一致 |

### 2.2 治理流程系统

| 场景ID | 场景描述 | 关键验证点 | 预期结果 |
|---|---|---|---|
| **ITS-GOV-01** | **提案创建与投票权检查** | 用户创建提案，系统验证其投票权（基础+NFT加成）是否满足阈值 | 1. 投票权计算准确（调用`CBVotingManager`） 2. 满足阈值则`ProposalCreated`事件触发 3. 不满足则返回错误 |
| **ITS-GOV-02** | **基本投票流程** | 用户对提案投票，系统记录投票并更新状态 | 1. `VoteCast`事件被捕获 2. 投票记录正确写入数据库 3. 提案投票统计更新 |
| **ITS-GOV-03** | **投票权重快照** | 系统在提案创建时或投票时使用正确的区块快照获取投票权重 | 1. 验证投票权重与指定区块的代币和NFT持有情况一致 |
| **ITS-GOV-04** | **提案状态流转** | 提案从创建到投票、队列、执行等状态按预期流转 | 1. 监听`ProposalStatusChanged`等事件 2. 验证系统状态与链上状态一致 |
| **ITS-GOV-05** | **提案执行** | 提案通过并到达执行时间后，系统成功调用合约执行提案 | 1. `ProposalExecuted`事件被捕获 2. 提案中定义的操作被执行（如参数修改） 3. 系统状态更新 |

### 2.3 NFT与治理联动

| 场景ID | 场景描述 | 关键验证点 | 预期结果 |
|---|---|---|---|
| **ITS-NGL-01** | **治理参与触发成就** | 用户首次投票后，系统自动解锁“首次投票”成就 | 1. 监听到`VoteCast`事件 2. 触发成就解锁流程 3. 用户获得“首次投票”NFT |
| **ITS-NGL-02** | **NFT影响投票权重** | 用户持有特定NFT，其投票权重计算结果包含NFT加成 | 1. 调用`CBVotingManager.getVotes`验证权重计算包含加成 |

## 3. 测试建议

- **优先执行高风险场景**: 首先测试核心业务流程和关键集成点。
- **模拟依赖**: 对于尚未完全就绪的外部依赖（如特定前端组件），使用模拟数据或工具进行测试。
- **数据一致性检查**: 在每个关键步骤后，验证链上数据、数据库数据和缓存数据的一致性。
- **错误注入**: 主动注入错误（如网络延迟、合约调用失败）来测试系统的健壮性。
- **跨团队沟通**: 与CB-BACKEND和CB-FRONTEND团队保持密切沟通，及时同步测试进展和发现的问题。

## 4. 结论

本提炼的关键测试场景为CB-FEATURES团队提供了集成测试的重点方向。请结合完整的《NFT与治理系统集成测试指南》进行全面测试，确保成就触发系统和治理流程系统与智能合约的集成质量。CB-DESIGN团队随时准备提供支持。
